# Copyright 2025 Telefonica Investigacion y Desarrollo, S.A.U
#
# This file is part of Orion Context Broker.
#
# Orion Context Broker is free software: you can redistribute it and/or
# modify it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# Orion Context Broker is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
# General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with Orion Context Broker. If not, see http://www.gnu.org/licenses/.
#
# For those usages not covered by this license please contact with
# iot_support at tid dot es
#
# ─────────── Common blocks (anchors)───────────
x-kafka-env: &kafka_env
  KAFKA_PROCESS_ROLES: broker,controller
  KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
  KAFKA_LOG_DIRS: /var/lib/kafka/data
  KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
  KAFKA_LOG4J_ROOT_LOGLEVEL: "OFF"
  KAFKA_LOG4J_LOGGERS: ""
  KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
  KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

# Common for the 2-node cluster (kafka1/kafka2)
x-kafka-env-2node: &kafka_env_2node
  <<: *kafka_env
  # Controllers in DIFFERENT PORTS (host networking ⇒ cannot be repeated)
  KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka1:29093,2@kafka2:29093
  KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
  KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 2
  KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
  # Valid CLUSTER_ID derived from “cluster_test” (22 chars Base64 URL-safe)
  CLUSTER_ID: IUReO9E0W926J9OLjW5UXw

# Common Kafka service configuration
x-kafka-svc: &kafka_svc
  image: confluentinc/cp-kafka:7.5.0
  logging: { driver: "none" }

services:
  # ─────────────────── Infra ───────────────────
  mongodb:
    image: mongo:8.0
    container_name: mongodb
    ports:
      - 27017:27017

  mosquitto:
    container_name: mosquitto
    image: eclipse-mosquitto:2.0.11
    ports:
      - "1883:1883"
    volumes:
      - ./test/functionalTest/mosquittoConf/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./test/functionalTest/mosquittoConf/mosquitto_passwd:/mosquitto/config/mosquitto_passwd:ro

  mosquitto-extra:
    container_name: mosquitto-extra
    image: eclipse-mosquitto:2.0.11
    ports:
      - "1884:1884"
    volumes:
      - ./test/functionalTest/mosquittoConf/mosquitto-extra.conf:/mosquitto/config/mosquitto.conf:ro
      - ./test/functionalTest/mosquittoConf/mosquitto_passwd:/mosquitto/config/mosquitto_passwd:ro

  # Kafka cluster A (2 brokers kafka1, kafka2)
  kafka1:
    <<: *kafka_svc
    container_name: kafka1
    ports: [ "9092:9092" ]
    environment:
      <<: *kafka_env_2node
      KAFKA_NODE_ID: 1
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:19092,EXTERNAL://0.0.0.0:9092,CONTROLLER://0.0.0.0:29093
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka1:19092,EXTERNAL://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

  kafka2:
    <<: *kafka_svc
    container_name: kafka2
    ports: [ "9094:9094" ]
    environment:
      <<: *kafka_env_2node
      KAFKA_NODE_ID: 2
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:19094,EXTERNAL://0.0.0.0:9094,CONTROLLER://0.0.0.0:29093
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka2:19094,EXTERNAL://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

  #  Kafka cluster B (independent of cluster A)
  kafkaB:
    <<: *kafka_svc
    container_name: kafkaB
    ports: [ "9095:9095" ]
    environment:
      <<: *kafka_env
      KAFKA_NODE_ID: 1
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:19095,EXTERNAL://0.0.0.0:9095,CONTROLLER://0.0.0.0:39093
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafkaB:19095,EXTERNAL://localhost:9095
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafkaB:39093
      # Valid CLUSTER_ID derived from “cluster_test_2” (22 chars Base64 URL-safe)
      CLUSTER_ID: 4aHwR_RyUaG-30kA4XyKpQ

  kafkaSasl:
    <<: *kafka_svc
    container_name: kafkaSasl
    ports:
      - "9096:9096"     # SASL_PLAINTEXT client listener (Orion)
      - "29096:29096"   # PLAINTEXT tools listener (kafkaCreateTopics/accumulator from host)
      - "49093:49093"   # controller (optional to expose; harmless)
    environment:
      <<: *kafka_env
      KAFKA_NODE_ID: 1

      # KRaft controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafkaSasl:49093
      CLUSTER_ID: 9Qq1d3m8R5q2kW0mXyZ1AA

      # Listeners:
      # - TOOLS: PLAINTEXT (no auth) for test utilities
      # - EXTERNAL: SASL_PLAINTEXT (auth) for Orion
      # - INTERNAL/CONTROLLER: PLAINTEXT (kraft/internal)
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:19096,TOOLS://0.0.0.0:29096,EXTERNAL://0.0.0.0:9096,CONTROLLER://0.0.0.0:49093
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafkaSasl:19096,TOOLS://localhost:29096,EXTERNAL://localhost:9096
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,TOOLS:PLAINTEXT,EXTERNAL:SASL_PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

      # SASL PLAIN
      KAFKA_SASL_ENABLED_MECHANISMS: PLAIN
      KAFKA_LISTENER_NAME_EXTERNAL_PLAIN_SASL_JAAS_CONFIG: >-
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="admin"
        password="admin-secret"
        user_admin="admin-secret"
        user_test="test-secret";