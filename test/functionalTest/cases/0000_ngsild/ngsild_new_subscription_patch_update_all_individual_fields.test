# Copyright 2023 FIWARE Foundation e.V.
#
# This file is part of Orion-LD Context Broker.
#
# Orion-LD Context Broker is free software: you can redistribute it and/or
# modify it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# Orion-LD Context Broker is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
# General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with Orion-LD Context Broker. If not, see http://www.gnu.org/licenses/.
#
# For those usages not covered by this license please contact with
# orionld at fiware dot org

# VALGRIND_READY - to mark the test ready for valgrindTestSuite.sh

--NAME--
Subscription Patch

--SHELL-INIT--
dbInit CB
orionldStart CB -experimental

--SHELL--

#
# "id" and "type" cannot be altered, nor "status" that is Read-Only.
# All other fields are altered in this test.
#
# 01. Create a subscription with all fields (except timeInterval)
# 02. MONGO: see expansions of: entities:type:T1, watchedAttributes:P2, q:P2, notification:attributes:P1,P2,A3, condition:P2
# 03. GET subscription from the broker
#
# 04. PATCH 'subscriptionName'
# 05. GET subscription and see the new 'subscriptionName'
# 06. PATCH 'description'
# 07. GET subscription and see the new 'description'
# 08. PATCH 'entities'
# 09. MONGO: see the expanded entity types
# 10. GET subscription and see the new 'entities'
# 11. PATCH 'watchedAttributes'
# 12. MONGO: see the expanded attrs in 'conditions'
# 13. GET subscription and see the new 'watchedAttributes'
# 14. PATCH 'timeInterval' and see error
# 15. PATCH 'q'
# 16. MONGO: see the expanded attributes in 'q'
# 17. GET subscription and see the new 'q'
# 18. PATCH 'geoQ'
# 19. MONGO: see 'geoQ'
# 20. GET subscription and see the new 'geoQ'
# 23. PATCH 'isActive' - set it to false
# 24. MONGO: see 'status == inactive'
# 25. GET subscription and see the new 'isActive'
# 26. PATCH 'notification'
# 27. MONGO: see the expanded attributes in 'notification'
# 28. GET subscription and see the new 'notification'
# 29. PATCH 'expiresAt'
# 30. GET subscription and see the new 'expiresAt'
# 31. PATCH 'throttling'
# 32. GET subscription and see the new 'throttling'
# 33. MONGO: check expansions of: entities:type, watchedAttributes, notification:attributes, condition
# 34. PATCH all patchable fields
# 35. GET subscription and see all the fields
# 36. MONGO: check expansions of: entities:type, watchedAttributes, notification:attributes, condition
# 37. PATCH 'receiverInfo' adding A=1
# 38. MONGO: check receiverInfo in the DB
# 39. GET subscription and see A=1 in receiverInfo
# 40. PATCH 'receiverInfo' modifying A=2
# 41. GET subscription and see A=2 in receiverInfo
# 42. PATCH 'notifierInfo' adding A=1
# 43. GET subscription and see A=1 in notifierInfo
# 44. PATCH 'notifierInfo' modifying A=2
# 45. GET subscription and see A=2 in notifierInfo
# 46. GET subscription from sub-cache - see the exact same as in 44
#

echo "01. Create a subscription with all fields (except timeInterval)"
echo "==============================================================="
payload='{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "name": "Test subscription S01",
  "description": "Description of Test subscription S01",
  "entities": [
    {
      "id": "urn:ngsi-ld:E01",
      "type": "T1"
    }
  ],
  "watchedAttributes": [ "P2" ],
  "q": "P2>10",
  "geoQ": {
    "geometry": "Point",
    "coordinates": [ 1, 2 ],
    "georel": "near;maxDistance==2000",
    "geoproperty": "geo0"
  },
  "isActive": true,
  "notification": {
    "attributes": [ "P1", "P2", "A3" ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:'$LISTENER_PORT'/notify",
      "accept": "application/ld+json"
    }
  },
  "expiresAt": "2028-12-31T10:00:00",
  "throttling": 5
}'
orionCurl --url /ngsi-ld/v1/subscriptions --payload "$payload"
echo
echo


echo "02. MONGO: see expansions of: entities:type:T1, watchedAttributes:P2, q:P2, notification:attributes:P1,P2,A3, condition:P2"
echo "=========================================================================================================================="
mongoCmd2 ftest "db.csubs.findOne()"
echo
echo


echo "03. GET subscription from the broker"
echo "===================================="
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "04. PATCH 'subscriptionName'"
echo "============================"
payload='{
  "name": "New Name"
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "05. GET subscription and see the new 'subscriptionName'"
echo "======================================================="
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "06. PATCH 'description'"
echo "======================="
payload='{
  "description": "New Description"
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "07. GET subscription and see the new 'description'"
echo "=================================================="
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "08. PATCH 'entities'"
echo "===================="
payload='{
  "entities": [
    {
      "type": "T2"
    },
    {
      "type": "T3"
    }    
  ]
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "09. MONGO: see the expanded entity types"
echo "========================================"
mongoCmd2 ftest "db.csubs.findOne()"
echo
echo


echo "10. GET subscription and see the new 'entities'"
echo "==============================================="
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "11. PATCH 'watchedAttributes'"
echo "============================="
payload='{
  "watchedAttributes": [ "W1" ]
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "12. MONGO: see the expanded attrs in 'conditions'"
echo "================================================="
mongoCmd2 ftest "db.csubs.findOne()"
echo
echo


echo "13. GET subscription and see the new 'watchedAttributes'"
echo "========================================================"
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo



echo "14. PATCH 'timeInterval' and see error"
echo "======================================"
payload='{
  "timeInterval": 5
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "15. PATCH 'q'"
echo "============="
payload='{
  "q": "A11>12;P1~=abc"
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "16. MONGO: see the expanded attributes in 'q'"
echo "============================================="
mongoCmd2 ftest "db.csubs.findOne()"
echo
echo


echo "17. GET subscription and see the new 'q'"
echo "========================================"
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "18. PATCH 'geoQ'"
echo "================"
payload='{
  "geoQ": {
    "geometry": "Point",
    "coordinates": [0,0],
    "georel": "near;maxDistance==18",
    "geoproperty": "geo1"
  }
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "19. MONGO: see 'geoQ'"
echo "====================="
mongoCmd2 ftest "db.csubs.findOne()"
echo
echo


echo "20. GET subscription and see the new 'geoQ'"
echo "==========================================="
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "23. PATCH 'isActive' - set it to false"
echo "======================================"
payload='{
  "isActive": false
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "24. MONGO: see 'status == inactive'"
echo "==================================="
mongoCmd2 ftest "db.csubs.findOne()"
echo
echo


echo "25. GET subscription and see the new 'isActive'"
echo "==============================================="
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "26. PATCH 'notification'"
echo "========================"
payload='{
  "notification": {
    "attributes": [ "R1", "R2", "P3" ],
    "format": "normalized",
    "endpoint": {
      "uri": "http://localhost:1234/notify2",
      "accept": "application/json"
    }  
  }
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "27. MONGO: see the expanded attributes in 'notification'"
echo "========================================================"
mongoCmd2 ftest "db.csubs.findOne()"
echo
echo


echo "28. GET subscription and see the new 'notification'"
echo "==================================================="
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "29. PATCH 'expiresAt'"
echo "====================="
payload='{
  "expiresAt": "2026-04-01T12:34:56"
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "30. GET subscription and see the new 'expiresAt'"
echo "================================================"
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "31. PATCH 'throttling'"
echo "======================"
payload='{
  "throttling": 12
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "32. GET subscription and see the new 'throttling'"
echo "================================================="
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "33. MONGO: check expansions of: entities:type, watchedAttributes, notification:attributes, condition"
echo "===================================================================================================="
mongoCmd2 ftest "db.csubs.findOne()"
echo
echo


echo "34. PATCH all patchable fields"
echo "=============================="
payload='{
  "name": "Name 34",
  "description": "Description 34",
  "entities": [
    {
      "id": "urn:ngsi-ld:E34",
      "type": "T34"
    },
    {
      "id": "urn:ngsi-ld:E34-2",
      "type": "T34-2"
    }    
  ],
  "watchedAttributes": [ "P34" ],
  "q": "P34>34",
  "geoQ": {
    "geometry": "Point",
    "coordinates": [ 34, 34 ],
    "georel": "near;maxDistance==34",
    "geoproperty": "geo34"
  },
  "isActive": true,
  "notification": {
    "attributes": [ "P34", "R34", "A34" ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:3434/notify",
      "accept": "application/ld+json"
    }
  },
  "expiresAt": "2028-12-31T10:34:34",
  "throttling": 34
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "35. GET subscription and see all the fields"
echo "==========================================="
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "36. MONGO: check expansions of: entities:type, watchedAttributes, notification:attributes, condition"
echo "===================================================================================================="
mongoCmd2 ftest "db.csubs.findOne()"
echo
echo


echo "37. PATCH 'receiverInfo' adding A=1"
echo "==================================="
payload='{
  "notification": {
    "endpoint": {
      "receiverInfo": [ { "key": "A", "value": "1" } ]
    }  
  }
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "38. MONGO: check receiverInfo in the DB"
echo "======================================="
mongoCmd2 ftest "db.csubs.findOne()"
echo
echo


echo "39. GET subscription and see A=1 in receiverInfo"
echo "================================================"
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "40. PATCH 'receiverInfo' modifying A=2"
echo "======================================"
payload='{
  "notification": {
    "endpoint": {
      "receiverInfo": [ { "key": "A", "value": "2" } ]
    }  
  }
}'
orionCurl --url /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01 -X PATCH --payload "$payload"
echo
echo


echo "41. GET subscription and see A=2 in receiverInfo"
echo "================================================"
orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


echo "42. PATCH 'notifierInfo' adding A=1"
echo "==================================="
echo
echo


echo "43. GET subscription and see A=1 in notifierInfo"
echo "================================================"
echo
echo


echo "44. PATCH 'notifierInfo' modifying A=2"
echo "======================================"
echo
echo


echo "45. GET subscription and see A=2 in notifierInfo"
echo "================================================"
echo
echo


echo "46. GET subscription from sub-cache - see the exact same as in 44"
echo "================================================================="
#orionCurl --url '/ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01?from=cache&prettyPrint=yes&spaces=2' --noPayloadCheck
echo
echo


--REGEXPECT--
01. Create a subscription with all fields (except timeInterval)
===============================================================
HTTP/1.1 201 Created
Content-Length: 0
Date: REGEX(.*)
Location: /ngsi-ld/v1/subscriptions/urn:ngsi-ld:subscriptions:S01



02. MONGO: see expansions of: entities:type:T1, watchedAttributes:P2, q:P2, notification:attributes:P1,P2,A3, condition:P2
==========================================================================================================================
MongoDB shell version REGEX(.*)
connecting to: REGEX(.*)
MongoDB server version: REGEX(.*)
{
	"_id" : "urn:ngsi-ld:subscriptions:S01",
	"name" : "Test subscription S01",
	"description" : "Description of Test subscription S01",
	"entities" : [
		{
			"id" : "urn:ngsi-ld:E01",
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T1",
			"isPattern" : "false",
			"isTypePattern" : false
		}
	],
	"conditions" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P2"
	],
	"ldQ" : "https://uri=etsi=org/ngsi-ld/default-context/P2.value>10",
	"expression" : {
		"geometry" : "point",
		"coords" : "1,2",
		"georel" : "near;maxDistance:2000",
		"geoproperty" : "https://uri=etsi=org/ngsi-ld/default-context/geo0",
		"q" : "https://uri=etsi=org/ngsi-ld/default-context/P2.value>10",
		"mq" : ""
	},
	"status" : "active",
	"expiration" : REGEX(.*),
	"throttling" : 5,
	"createdAt" : REGEX(\d+\.\d+),
	"modifiedAt" : REGEX(\d+\.\d+),
	"attrs" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P1",
		"https://uri.etsi.org/ngsi-ld/default-context/P2",
		"https://uri.etsi.org/ngsi-ld/default-context/A3"
	],
	"format" : "keyValues",
	"reference" : "http://localhost:9997/notify",
	"mimeType" : "application/ld+json",
	"custom" : false,
	"servicePath" : "/#",
	"blacklist" : false,
	"ldContext" : "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
}
bye


03. GET subscription from the broker
====================================
HTTP/1.1 200 OK
Content-Length: 831
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "Test subscription S01",
  "description": "Description of Test subscription S01",
  "entities": [
    {
      "id": "urn:ngsi-ld:E01",
      "type": "T1"
    }
  ],
  "watchedAttributes": [
    "P2"
  ],
  "q": "P2>10",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==2000",
    "coordinates": [
      1,
      2
    ],
    "geoproperty": "geo0"
  },
  "status": "active",
  "isActive": true,
  "notification": {
    "attributes": [
      "P1",
      "P2",
      "A3"
    ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:9997/notify",
      "accept": "application/ld+json"
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:00:00.000Z",
  "throttling": 5,
  "origin": "cache"
}



04. PATCH 'subscriptionName'
============================
HTTP/1.1 204 No Content
Date: REGEX(.*)



05. GET subscription and see the new 'subscriptionName'
=======================================================
HTTP/1.1 200 OK
Content-Length: 818
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "New Name",
  "description": "Description of Test subscription S01",
  "entities": [
    {
      "id": "urn:ngsi-ld:E01",
      "type": "T1"
    }
  ],
  "watchedAttributes": [
    "P2"
  ],
  "q": "P2>10",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==2000",
    "coordinates": [
      1,
      2
    ],
    "geoproperty": "geo0"
  },
  "status": "active",
  "isActive": true,
  "notification": {
    "attributes": [
      "P1",
      "P2",
      "A3"
    ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:9997/notify",
      "accept": "application/ld+json"
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:00:00.000Z",
  "throttling": 5,
  "origin": "cache"
}



06. PATCH 'description'
=======================
HTTP/1.1 204 No Content
Date: REGEX(.*)



07. GET subscription and see the new 'description'
==================================================
HTTP/1.1 200 OK
Content-Length: 797
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "New Name",
  "description": "New Description",
  "entities": [
    {
      "id": "urn:ngsi-ld:E01",
      "type": "T1"
    }
  ],
  "watchedAttributes": [
    "P2"
  ],
  "q": "P2>10",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==2000",
    "coordinates": [
      1,
      2
    ],
    "geoproperty": "geo0"
  },
  "status": "active",
  "isActive": true,
  "notification": {
    "attributes": [
      "P1",
      "P2",
      "A3"
    ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:9997/notify",
      "accept": "application/ld+json"
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:00:00.000Z",
  "throttling": 5,
  "origin": "cache"
}



08. PATCH 'entities'
====================
HTTP/1.1 204 No Content
Date: REGEX(.*)



09. MONGO: see the expanded entity types
========================================
MongoDB shell REGEX(.*)
connecting to: REGEX(.*)
MongoDB server version: REGEX(.*)
{
	"_id" : "urn:ngsi-ld:subscriptions:S01",
	"name" : "New Name",
	"description" : "New Description",
	"entities" : [
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T2",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		},
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T3",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		}
	],
	"conditions" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P2"
	],
	"ldQ" : "https://uri=etsi=org/ngsi-ld/default-context/P2.value>10",
	"expression" : {
		"geometry" : "point",
		"coords" : "1,2",
		"georel" : "near;maxDistance:2000",
		"geoproperty" : "https://uri=etsi=org/ngsi-ld/default-context/geo0",
		"q" : "https://uri=etsi=org/ngsi-ld/default-context/P2.value>10",
		"mq" : ""
	},
	"status" : "active",
	"expiration" : 1861869600,
	"throttling" : 5,
	"createdAt" : REGEX(\d+\.\d+),
	"modifiedAt" : REGEX(\d+\.\d+),
	"attrs" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P1",
		"https://uri.etsi.org/ngsi-ld/default-context/P2",
		"https://uri.etsi.org/ngsi-ld/default-context/A3"
	],
	"format" : "keyValues",
	"reference" : "http://localhost:9997/notify",
	"mimeType" : "application/ld+json",
	"custom" : false,
	"servicePath" : "/#",
	"blacklist" : false,
	"ldContext" : "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
}
bye


10. GET subscription and see the new 'entities'
===============================================
HTTP/1.1 200 OK
Content-Length: 798
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "New Name",
  "description": "New Description",
  "entities": [
    {
      "type": "T2"
    },
    {
      "type": "T3"
    }
  ],
  "watchedAttributes": [
    "P2"
  ],
  "q": "P2>10",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==2000",
    "coordinates": [
      1,
      2
    ],
    "geoproperty": "geo0"
  },
  "status": "active",
  "isActive": true,
  "notification": {
    "attributes": [
      "P1",
      "P2",
      "A3"
    ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:9997/notify",
      "accept": "application/ld+json"
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:00:00.000Z",
  "throttling": 5,
  "origin": "cache"
}



11. PATCH 'watchedAttributes'
=============================
HTTP/1.1 204 No Content
Date: REGEX(.*)



12. MONGO: see the expanded attrs in 'conditions'
=================================================
MongoDB shell REGEX(.*)
connecting to: REGEX(.*)
MongoDB server version: REGEX(.*)
{
	"_id" : "urn:ngsi-ld:subscriptions:S01",
	"name" : "New Name",
	"description" : "New Description",
	"entities" : [
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T2",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		},
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T3",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		}
	],
	"conditions" : [
		"https://uri.etsi.org/ngsi-ld/default-context/W1"
	],
	"ldQ" : "https://uri=etsi=org/ngsi-ld/default-context/P2.value>10",
	"expression" : {
		"geometry" : "point",
		"coords" : "1,2",
		"georel" : "near;maxDistance:2000",
		"geoproperty" : "https://uri=etsi=org/ngsi-ld/default-context/geo0",
		"q" : "https://uri=etsi=org/ngsi-ld/default-context/P2.value>10",
		"mq" : ""
	},
	"status" : "active",
	"expiration" : 1861869600,
	"throttling" : 5,
	"createdAt" : REGEX(\d+\.\d+),
	"modifiedAt" : REGEX(\d+\.\d+),
	"attrs" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P1",
		"https://uri.etsi.org/ngsi-ld/default-context/P2",
		"https://uri.etsi.org/ngsi-ld/default-context/A3"
	],
	"format" : "keyValues",
	"reference" : "http://localhost:9997/notify",
	"mimeType" : "application/ld+json",
	"custom" : false,
	"servicePath" : "/#",
	"blacklist" : false,
	"ldContext" : "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
}
bye


13. GET subscription and see the new 'watchedAttributes'
========================================================
HTTP/1.1 200 OK
Content-Length: 798
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "New Name",
  "description": "New Description",
  "entities": [
    {
      "type": "T2"
    },
    {
      "type": "T3"
    }
  ],
  "watchedAttributes": [
    "W1"
  ],
  "q": "P2>10",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==2000",
    "coordinates": [
      1,
      2
    ],
    "geoproperty": "geo0"
  },
  "status": "active",
  "isActive": true,
  "notification": {
    "attributes": [
      "P1",
      "P2",
      "A3"
    ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:9997/notify",
      "accept": "application/ld+json"
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:00:00.000Z",
  "throttling": 5,
  "origin": "cache"
}



14. PATCH 'timeInterval' and see error
======================================
HTTP/1.1 501 Not Implemented
Content-Length: 137
Content-Type: application/json
Date: REGEX(.*)

{
    "detail": "Time-Interval for Subscriptions",
    "title": "Not Implemented",
    "type": "https://uri.etsi.org/ngsi-ld/errors/OperationNotSupported"
}


15. PATCH 'q'
=============
HTTP/1.1 204 No Content
Date: REGEX(.*)



16. MONGO: see the expanded attributes in 'q'
=============================================
MongoDB shell version REGEX(.)
connecting to: REGEX(.)
MongoDB server version: REGEX(.)
{
	"_id" : "urn:ngsi-ld:subscriptions:S01",
	"name" : "New Name",
	"description" : "New Description",
	"entities" : [
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T2",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		},
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T3",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		}
	],
	"conditions" : [
		"https://uri.etsi.org/ngsi-ld/default-context/W1"
	],
	"ldQ" : "https://uri=etsi=org/ngsi-ld/default-context/A11.value>12;https://uri=etsi=org/ngsi-ld/default-context/P1.value~=abc",
	"expression" : {
		"geometry" : "point",
		"coords" : "1,2",
		"georel" : "near;maxDistance:2000",
		"geoproperty" : "https://uri=etsi=org/ngsi-ld/default-context/geo0",
		"q" : "https://uri=etsi=org/ngsi-ld/default-context/A11.value>12;https://uri=etsi=org/ngsi-ld/default-context/P1.value~=abc",
		"mq" : ""
	},
	"status" : "active",
	"expiration" : 1861869600,
	"throttling" : 5,
	"createdAt" : REGEX(\d+\.\d+),
	"modifiedAt" : REGEX(\d+\.\d+),
	"attrs" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P1",
		"https://uri.etsi.org/ngsi-ld/default-context/P2",
		"https://uri.etsi.org/ngsi-ld/default-context/A3"
	],
	"format" : "keyValues",
	"reference" : "http://localhost:9997/notify",
	"mimeType" : "application/ld+json",
	"custom" : false,
	"servicePath" : "/#",
	"blacklist" : false,
	"ldContext" : "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
}
bye


17. GET subscription and see the new 'q'
========================================
HTTP/1.1 200 OK
Content-Length: 807
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "New Name",
  "description": "New Description",
  "entities": [
    {
      "type": "T2"
    },
    {
      "type": "T3"
    }
  ],
  "watchedAttributes": [
    "W1"
  ],
  "q": "A11>12;P1~=abc",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==2000",
    "coordinates": [
      1,
      2
    ],
    "geoproperty": "geo0"
  },
  "status": "active",
  "isActive": true,
  "notification": {
    "attributes": [
      "P1",
      "P2",
      "A3"
    ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:9997/notify",
      "accept": "application/ld+json"
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:00:00.000Z",
  "throttling": 5,
  "origin": "cache"
}



18. PATCH 'geoQ'
================
HTTP/1.1 204 No Content
Date: REGEX(.*)



19. MONGO: see 'geoQ'
=====================
MongoDB shell version REGEX(.)
connecting to: REGEX(.)
MongoDB server version: REGEX(.)
{
	"_id" : "urn:ngsi-ld:subscriptions:S01",
	"name" : "New Name",
	"description" : "New Description",
	"entities" : [
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T2",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		},
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T3",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		}
	],
	"conditions" : [
		"https://uri.etsi.org/ngsi-ld/default-context/W1"
	],
	"ldQ" : "https://uri=etsi=org/ngsi-ld/default-context/A11.value>12;https://uri=etsi=org/ngsi-ld/default-context/P1.value~=abc",
	"expression" : {
		"q" : "https://uri=etsi=org/ngsi-ld/default-context/A11.value>12;https://uri=etsi=org/ngsi-ld/default-context/P1.value~=abc",
		"mq" : "",
		"geometry" : "point",
		"coords" : "0,0",
		"georel" : "near;maxDistance:18",
		"geoproperty" : "https://uri=etsi=org/ngsi-ld/default-context/geo1"
	},
	"status" : "active",
	"expiration" : 1861869600,
	"throttling" : 5,
	"createdAt" : REGEX(\d+\.\d+),
	"modifiedAt" : REGEX(\d+\.\d+),
	"attrs" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P1",
		"https://uri.etsi.org/ngsi-ld/default-context/P2",
		"https://uri.etsi.org/ngsi-ld/default-context/A3"
	],
	"format" : "keyValues",
	"reference" : "http://localhost:9997/notify",
	"mimeType" : "application/ld+json",
	"custom" : false,
	"servicePath" : "/#",
	"blacklist" : false,
	"ldContext" : "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
}
bye


20. GET subscription and see the new 'geoQ'
===========================================
HTTP/1.1 200 OK
Content-Length: 786
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "New Name",
  "description": "New Description",
  "entities": [
    {
      "type": "T2"
    },
    {
      "type": "T3"
    }
  ],
  "watchedAttributes": [
    "W1"
  ],
  "q": "A11>12;P1~=abc",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==18",
    "coordinates": "0,0",
    "geoproperty": "geo1"
  },
  "status": "active",
  "isActive": true,
  "notification": {
    "attributes": [
      "P1",
      "P2",
      "A3"
    ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:9997/notify",
      "accept": "application/ld+json"
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:00:00.000Z",
  "throttling": 5,
  "origin": "cache"
}



23. PATCH 'isActive' - set it to false
======================================
HTTP/1.1 204 No Content
Date: REGEX(.*)



24. MONGO: see 'status == inactive'
===================================
MongoDB shell version REGEX(.)
connecting to: REGEX(.)
MongoDB server version: REGEX(.)
{
	"_id" : "urn:ngsi-ld:subscriptions:S01",
	"name" : "New Name",
	"description" : "New Description",
	"entities" : [
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T2",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		},
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T3",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		}
	],
	"conditions" : [
		"https://uri.etsi.org/ngsi-ld/default-context/W1"
	],
	"ldQ" : "https://uri=etsi=org/ngsi-ld/default-context/A11.value>12;https://uri=etsi=org/ngsi-ld/default-context/P1.value~=abc",
	"expression" : {
		"q" : "https://uri=etsi=org/ngsi-ld/default-context/A11.value>12;https://uri=etsi=org/ngsi-ld/default-context/P1.value~=abc",
		"mq" : "",
		"geometry" : "point",
		"coords" : "0,0",
		"georel" : "near;maxDistance:18",
		"geoproperty" : "https://uri=etsi=org/ngsi-ld/default-context/geo1"
	},
	"status" : "inactive",
	"expiration" : 1861869600,
	"throttling" : 5,
	"createdAt" : REGEX(\d+\.\d+),
	"modifiedAt" : REGEX(\d+\.\d+),
	"attrs" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P1",
		"https://uri.etsi.org/ngsi-ld/default-context/P2",
		"https://uri.etsi.org/ngsi-ld/default-context/A3"
	],
	"format" : "keyValues",
	"reference" : "http://localhost:9997/notify",
	"mimeType" : "application/ld+json",
	"custom" : false,
	"servicePath" : "/#",
	"blacklist" : false,
	"ldContext" : "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
}
bye


25. GET subscription and see the new 'isActive'
===============================================
HTTP/1.1 200 OK
Content-Length: 787
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "New Name",
  "description": "New Description",
  "entities": [
    {
      "type": "T2"
    },
    {
      "type": "T3"
    }
  ],
  "watchedAttributes": [
    "W1"
  ],
  "q": "A11>12;P1~=abc",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==18",
    "coordinates": "0,0",
    "geoproperty": "geo1"
  },
  "status": "paused",
  "isActive": false,
  "notification": {
    "attributes": [
      "P1",
      "P2",
      "A3"
    ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:9997/notify",
      "accept": "application/ld+json"
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:00:00.000Z",
  "throttling": 5,
  "origin": "cache"
}



26. PATCH 'notification'
========================
HTTP/1.1 204 No Content
Date: REGEX(.*)



27. MONGO: see the expanded attributes in 'notification'
========================================================
MongoDB shell version REGEX(.)
connecting to: REGEX(.)
MongoDB server version: REGEX(.)
{
	"_id" : "urn:ngsi-ld:subscriptions:S01",
	"name" : "New Name",
	"description" : "New Description",
	"entities" : [
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T2",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		},
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T3",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		}
	],
	"conditions" : [
		"https://uri.etsi.org/ngsi-ld/default-context/W1"
	],
	"ldQ" : "https://uri=etsi=org/ngsi-ld/default-context/A11.value>12;https://uri=etsi=org/ngsi-ld/default-context/P1.value~=abc",
	"expression" : {
		"q" : "https://uri=etsi=org/ngsi-ld/default-context/A11.value>12;https://uri=etsi=org/ngsi-ld/default-context/P1.value~=abc",
		"mq" : "",
		"geometry" : "point",
		"coords" : "0,0",
		"georel" : "near;maxDistance:18",
		"geoproperty" : "https://uri=etsi=org/ngsi-ld/default-context/geo1"
	},
	"status" : "inactive",
	"expiration" : 1861869600,
	"throttling" : 5,
	"createdAt" : REGEX(\d+\.\d+),
	"modifiedAt" : REGEX(\d+\.\d+),
	"attrs" : [
		"https://uri.etsi.org/ngsi-ld/default-context/R1",
		"https://uri.etsi.org/ngsi-ld/default-context/R2",
		"https://uri.etsi.org/ngsi-ld/default-context/P3"
	],
	"format" : "normalized",
	"reference" : "http://localhost:1234/notify2",
	"mimeType" : "application/json",
	"custom" : false,
	"servicePath" : "/#",
	"blacklist" : false,
	"ldContext" : "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
}
bye


28. GET subscription and see the new 'notification'
===================================================
HTTP/1.1 200 OK
Content-Length: 786
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "New Name",
  "description": "New Description",
  "entities": [
    {
      "type": "T2"
    },
    {
      "type": "T3"
    }
  ],
  "watchedAttributes": [
    "W1"
  ],
  "q": "A11>12;P1~=abc",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==18",
    "coordinates": "0,0",
    "geoproperty": "geo1"
  },
  "status": "paused",
  "isActive": false,
  "notification": {
    "attributes": [
      "R1",
      "R2",
      "P3"
    ],
    "format": "normalized",
    "endpoint": {
      "uri": "http://localhost:1234/notify2",
      "accept": "application/json"
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:00:00.000Z",
  "throttling": 5,
  "origin": "cache"
}



29. PATCH 'expiresAt'
=====================
HTTP/1.1 204 No Content
Date: REGEX(.*)



30. GET subscription and see the new 'expiresAt'
================================================
HTTP/1.1 200 OK
Content-Length: 786
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "New Name",
  "description": "New Description",
  "entities": [
    {
      "type": "T2"
    },
    {
      "type": "T3"
    }
  ],
  "watchedAttributes": [
    "W1"
  ],
  "q": "A11>12;P1~=abc",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==18",
    "coordinates": "0,0",
    "geoproperty": "geo1"
  },
  "status": "paused",
  "isActive": false,
  "notification": {
    "attributes": [
      "R1",
      "R2",
      "P3"
    ],
    "format": "normalized",
    "endpoint": {
      "uri": "http://localhost:1234/notify2",
      "accept": "application/json"
    },
    "status": "ok"
  },
  "expiresAt": "2026-04-01T12:34:56.000Z",
  "throttling": 5,
  "origin": "cache"
}



31. PATCH 'throttling'
======================
HTTP/1.1 204 No Content
Date: REGEX(.*)



32. GET subscription and see the new 'throttling'
=================================================
HTTP/1.1 200 OK
Content-Length: 787
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "New Name",
  "description": "New Description",
  "entities": [
    {
      "type": "T2"
    },
    {
      "type": "T3"
    }
  ],
  "watchedAttributes": [
    "W1"
  ],
  "q": "A11>12;P1~=abc",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==18",
    "coordinates": "0,0",
    "geoproperty": "geo1"
  },
  "status": "paused",
  "isActive": false,
  "notification": {
    "attributes": [
      "R1",
      "R2",
      "P3"
    ],
    "format": "normalized",
    "endpoint": {
      "uri": "http://localhost:1234/notify2",
      "accept": "application/json"
    },
    "status": "ok"
  },
  "expiresAt": "2026-04-01T12:34:56.000Z",
  "throttling": 12,
  "origin": "cache"
}



33. MONGO: check expansions of: entities:type, watchedAttributes, notification:attributes, condition
====================================================================================================
MongoDB shell version REGEX(.)
connecting to: REGEX(.)
MongoDB server version: REGEX(.)
{
	"_id" : "urn:ngsi-ld:subscriptions:S01",
	"name" : "New Name",
	"description" : "New Description",
	"entities" : [
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T2",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		},
		{
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T3",
			"id" : ".*",
			"isPattern" : "true",
			"isTypePattern" : false
		}
	],
	"conditions" : [
		"https://uri.etsi.org/ngsi-ld/default-context/W1"
	],
	"ldQ" : "https://uri=etsi=org/ngsi-ld/default-context/A11.value>12;https://uri=etsi=org/ngsi-ld/default-context/P1.value~=abc",
	"expression" : {
		"q" : "https://uri=etsi=org/ngsi-ld/default-context/A11.value>12;https://uri=etsi=org/ngsi-ld/default-context/P1.value~=abc",
		"mq" : "",
		"geometry" : "point",
		"coords" : "0,0",
		"georel" : "near;maxDistance:18",
		"geoproperty" : "https://uri=etsi=org/ngsi-ld/default-context/geo1"
	},
	"status" : "inactive",
	"expiration" : 1775046896,
	"throttling" : 12,
	"createdAt" : REGEX(\d+\.\d+),
	"modifiedAt" : REGEX(\d+\.\d+),
	"attrs" : [
		"https://uri.etsi.org/ngsi-ld/default-context/R1",
		"https://uri.etsi.org/ngsi-ld/default-context/R2",
		"https://uri.etsi.org/ngsi-ld/default-context/P3"
	],
	"format" : "normalized",
	"reference" : "http://localhost:1234/notify2",
	"mimeType" : "application/json",
	"custom" : false,
	"servicePath" : "/#",
	"blacklist" : false,
	"ldContext" : "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
}
bye


34. PATCH all patchable fields
==============================
HTTP/1.1 204 No Content
Date: REGEX(.*)



35. GET subscription and see all the fields
===========================================
HTTP/1.1 200 OK
Content-Length: 852
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "Name 34",
  "description": "Description 34",
  "entities": [
    {
      "id": "urn:ngsi-ld:E34",
      "type": "T34"
    },
    {
      "id": "urn:ngsi-ld:E34-2",
      "type": "T34-2"
    }
  ],
  "watchedAttributes": [
    "P34"
  ],
  "q": "P34>34",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==34",
    "coordinates": "34,34",
    "geoproperty": "geo34"
  },
  "status": "active",
  "isActive": true,
  "notification": {
    "attributes": [
      "P34",
      "R34",
      "A34"
    ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:3434/notify",
      "accept": "application/ld+json"
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:34:34.000Z",
  "throttling": 34,
  "origin": "cache"
}



36. MONGO: check expansions of: entities:type, watchedAttributes, notification:attributes, condition
====================================================================================================
MongoDB shell version REGEX(.)
connecting to: REGEX(.)
MongoDB server version: REGEX(.)
{
	"_id" : "urn:ngsi-ld:subscriptions:S01",
	"name" : "Name 34",
	"description" : "Description 34",
	"entities" : [
		{
			"id" : "urn:ngsi-ld:E34",
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T34",
			"isPattern" : "false",
			"isTypePattern" : false
		},
		{
			"id" : "urn:ngsi-ld:E34-2",
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T34-2",
			"isPattern" : "false",
			"isTypePattern" : false
		}
	],
	"conditions" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P34"
	],
	"ldQ" : "https://uri=etsi=org/ngsi-ld/default-context/P34.value>34",
	"expression" : {
		"q" : "https://uri=etsi=org/ngsi-ld/default-context/P34.value>34",
		"mq" : "",
		"geometry" : "point",
		"coords" : "34,34",
		"georel" : "near;maxDistance:34",
		"geoproperty" : "https://uri=etsi=org/ngsi-ld/default-context/geo34"
	},
	"status" : "active",
	"expiration" : 1861871674,
	"throttling" : 34,
	"createdAt" : REGEX(\d+\.\d+),
	"modifiedAt" : REGEX(\d+\.\d+),
	"attrs" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P34",
		"https://uri.etsi.org/ngsi-ld/default-context/R34",
		"https://uri.etsi.org/ngsi-ld/default-context/A34"
	],
	"format" : "keyValues",
	"reference" : "http://localhost:3434/notify",
	"mimeType" : "application/ld+json",
	"custom" : false,
	"servicePath" : "/#",
	"blacklist" : false,
	"ldContext" : "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
}
bye


37. PATCH 'receiverInfo' adding A=1
===================================
HTTP/1.1 204 No Content
Date: REGEX(.*)



38. MONGO: check receiverInfo in the DB
=======================================
MongoDB shell version REGEX(.)
connecting to: REGEX(.)
MongoDB server version: REGEX(.)
{
	"_id" : "urn:ngsi-ld:subscriptions:S01",
	"name" : "Name 34",
	"description" : "Description 34",
	"entities" : [
		{
			"id" : "urn:ngsi-ld:E34",
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T34",
			"isPattern" : "false",
			"isTypePattern" : false
		},
		{
			"id" : "urn:ngsi-ld:E34-2",
			"type" : "https://uri.etsi.org/ngsi-ld/default-context/T34-2",
			"isPattern" : "false",
			"isTypePattern" : false
		}
	],
	"conditions" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P34"
	],
	"ldQ" : "https://uri=etsi=org/ngsi-ld/default-context/P34.value>34",
	"expression" : {
		"q" : "https://uri=etsi=org/ngsi-ld/default-context/P34.value>34",
		"mq" : "",
		"geometry" : "point",
		"coords" : "34,34",
		"georel" : "near;maxDistance:34",
		"geoproperty" : "https://uri=etsi=org/ngsi-ld/default-context/geo34"
	},
	"status" : "active",
	"expiration" : 1861871674,
	"throttling" : 34,
	"createdAt" : REGEX(\d+\.\d+),
	"modifiedAt" : REGEX(\d+\.\d+),
	"attrs" : [
		"https://uri.etsi.org/ngsi-ld/default-context/P34",
		"https://uri.etsi.org/ngsi-ld/default-context/R34",
		"https://uri.etsi.org/ngsi-ld/default-context/A34"
	],
	"format" : "keyValues",
	"reference" : "http://localhost:3434/notify",
	"mimeType" : "application/ld+json",
	"custom" : false,
	"servicePath" : "/#",
	"blacklist" : false,
	"ldContext" : "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld",
	"headers" : {
		"A" : "1"
	}
}
bye


39. GET subscription and see A=1 in receiverInfo
================================================
HTTP/1.1 200 OK
Content-Length: 950
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "Name 34",
  "description": "Description 34",
  "entities": [
    {
      "id": "urn:ngsi-ld:E34",
      "type": "T34"
    },
    {
      "id": "urn:ngsi-ld:E34-2",
      "type": "T34-2"
    }
  ],
  "watchedAttributes": [
    "P34"
  ],
  "q": "P34>34",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==34",
    "coordinates": "34,34",
    "geoproperty": "geo34"
  },
  "status": "active",
  "isActive": true,
  "notification": {
    "attributes": [
      "P34",
      "R34",
      "A34"
    ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:3434/notify",
      "accept": "application/ld+json",
      "receiverInfo": [
        {
          "key": "A",
          "value": "1"
        }
      ]
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:34:34.000Z",
  "throttling": 34,
  "origin": "cache"
}



40. PATCH 'receiverInfo' modifying A=2
======================================
HTTP/1.1 204 No Content
Date: REGEX(.*)



41. GET subscription and see A=2 in receiverInfo
================================================
HTTP/1.1 200 OK
Content-Length: 950
Content-Type: application/json
Date: REGEX(.*)
Link: <https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "id": "urn:ngsi-ld:subscriptions:S01",
  "type": "Subscription",
  "subscriptionName": "Name 34",
  "description": "Description 34",
  "entities": [
    {
      "id": "urn:ngsi-ld:E34",
      "type": "T34"
    },
    {
      "id": "urn:ngsi-ld:E34-2",
      "type": "T34-2"
    }
  ],
  "watchedAttributes": [
    "P34"
  ],
  "q": "P34>34",
  "geoQ": {
    "geometry": "Point",
    "georel": "near;maxDistance==34",
    "coordinates": "34,34",
    "geoproperty": "geo34"
  },
  "status": "active",
  "isActive": true,
  "notification": {
    "attributes": [
      "P34",
      "R34",
      "A34"
    ],
    "format": "keyValues",
    "endpoint": {
      "uri": "http://localhost:3434/notify",
      "accept": "application/ld+json",
      "receiverInfo": [
        {
          "key": "A",
          "value": "2"
        }
      ]
    },
    "status": "ok"
  },
  "expiresAt": "2028-12-31T10:34:34.000Z",
  "throttling": 34,
  "origin": "cache"
}



42. PATCH 'notifierInfo' adding A=1
===================================


43. GET subscription and see A=1 in notifierInfo
================================================


44. PATCH 'notifierInfo' modifying A=2
======================================


45. GET subscription and see A=2 in notifierInfo
================================================


46. GET subscription from sub-cache - see the exact same as in 44
=================================================================


--TEARDOWN--
brokerStop CB
dbDrop CB
